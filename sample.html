<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Community Safety System - Final</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>

<style>
body { margin:0; font-family:Arial; background:#eef2f7; }
header { background:#0f172a; color:white; padding:15px; text-align:center; }

section {
    margin:15px;
    padding:15px;
    background:white;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}

.grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:15px;
}

#map { height:400px; border-radius:10px; }

button {
    padding:10px 15px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}

#sosButton {
    position:fixed;
    bottom:20px;
    right:20px;
    background:red;
    color:white;
    font-weight:bold;
}

#gpsBtn {
    position:fixed;
    bottom:80px;
    right:20px;
    background:#2563eb;
    color:white;
}

form input, form textarea {
    width:100%;
    padding:8px;
    margin:5px 0;
    border-radius:6px;
    border:1px solid #ccc;
}

.success { color:green; font-weight:bold; }
</style>
</head>

<body>

<header>
<h1>Smart Community Safety & AI System</h1>
<p>Registration | Event Reporting | GPS | AI | Shake SOS | Dummy SMS</p>
</header>

<!-- USER REGISTRATION -->
<section>
<h2>üë§ User Registration</h2>
<form id="registerForm">
<input type="text" placeholder="Full Name" required>
<input type="email" placeholder="Email" required>
<input type="text" placeholder="Phone Number" required>
<button type="submit">Register</button>
</form>
<p id="registerMsg"></p>
</section>

<!-- EVENT FORM -->
<section>
<h2>üì¢ Report Event With Live Location</h2>
<form id="eventForm">
<input type="text" id="eventTitle" placeholder="Event Title" required>
<textarea id="eventDesc" placeholder="Describe Event" required></textarea>
<button type="submit">Submit Event</button>
</form>
<p id="eventMsg"></p>
</section>

<div class="grid">
<section>
<h2>AI Risk Prediction</h2>
<canvas id="riskChart"></canvas>
</section>

<section>
<h2>Live Risk Map</h2>
<div id="map"></div>
</section>
</div>

<button id="gpsBtn">üìç Enable GPS</button>
<button id="sosButton">üö® SOS ALERT</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

// ======================
// MAP SETUP
// ======================

const map = L.map('map').setView([19.0760,72.8777],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let userMarker;

// ======================
// GPS TRACKING
// ======================

document.getElementById("gpsBtn").onclick = function() {
    if(navigator.geolocation){
        navigator.geolocation.watchPosition(position=>{
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            if(!userMarker){
                userMarker = L.marker([lat,lon]).addTo(map)
                .bindPopup("üìç Live User Location").openPopup();
            } else {
                userMarker.setLatLng([lat,lon]);
            }

            map.setView([lat,lon],15);
        });
    }
};

// ======================
// USER REGISTRATION
// ======================

document.getElementById("registerForm").onsubmit = function(e){
    e.preventDefault();
    document.getElementById("registerMsg").innerHTML =
    "<span class='success'>User Registered Successfully ‚úÖ</span>";
    this.reset();
};

// ======================
// EVENT FORM WITH LOCATION
// ======================

document.getElementById("eventForm").onsubmit = function(e){
    e.preventDefault();

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(position=>{

            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            L.marker([lat,lon])
            .addTo(map)
            .bindPopup("üì¢ Event: "+ 
                       document.getElementById("eventTitle").value)
            .openPopup();

            document.getElementById("eventMsg").innerHTML =
            "<span class='success'>Event Submitted With Live Location ‚úÖ</span>";

            this.reset();
        });
    }
};

// ======================
// AI MODEL
// ======================

let model;

async function trainModel(){
    model = tf.sequential();
    model.add(tf.layers.dense({units:8,inputShape:[4],activation:'relu'}));
    model.add(tf.layers.dense({units:1}));

    model.compile({optimizer:'adam',loss:'meanSquaredError'});

    const xs = tf.randomUniform([200,4]);
    const ys = xs.mean(1);

    await model.fit(xs,ys,{epochs:40});
}

trainModel();

async function predictRisk(){
    if(!model) return;

    const input = tf.tensor([[Math.random(),Math.random(),Math.random(),Math.random()]]);
    const prediction = model.predict(input);
    const value = await prediction.data();
    const risk = Math.floor(value[0]*100);

    riskChart.data.datasets[0].data = [risk,risk-10,risk-20,risk-30];
    riskChart.update();
}

setInterval(predictRisk,4000);

const riskChart = new Chart(document.getElementById("riskChart"),{
    type:'bar',
    data:{
        labels:['Traffic','Water','Disease','Electric'],
        datasets:[{
            label:'Risk %',
            data:[40,30,20,10],
            backgroundColor:['red','orange','gold','green']
        }]
    }
});

// ======================
// SOS SYSTEM WITH DUMMY SMS + REAL LOCATION
// ======================

document.getElementById("sosButton").onclick = function(){

    if(navigator.geolocation){

        navigator.geolocation.getCurrentPosition(position=>{

            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            L.marker([lat,lon])
            .addTo(map)
            .bindPopup("üî¥ SOS Sent From Here")
            .openPopup();

            alert(
                "üì° SMS Sent Successfully!\n\n" +
                "üö® EMERGENCY ALERT üö®\n" +
                "User needs help.\n\n" +
                "Live Location:\n" +
                "https://www.google.com/maps?q=" + lat + "," + lon
            );

            sendSMS(lat, lon);

        });

    } else {
        alert("Geolocation not supported.");
    }
};

function sendSMS(lat, lon){

    const message = `
üö® EMERGENCY ALERT üö®
User needs immediate help.
Location:
https://www.google.com/maps?q=${lat},${lon}
`;

    console.log("Dummy SMS Sent:", message);

    // Ready for real SMS API integration
}

// ======================
// SHAKE DETECTION FOR SOS
// ======================

let lastX=null,lastY=null,lastZ=null;
let shakeThreshold=18;

window.addEventListener("devicemotion",function(event){
    let acc = event.accelerationIncludingGravity;
    if(!acc) return;

    if(lastX!==null){
        let deltaX=Math.abs(lastX-acc.x);
        let deltaY=Math.abs(lastY-acc.y);
        let deltaZ=Math.abs(lastZ-acc.z);

        if(deltaX+deltaY+deltaZ > shakeThreshold){

            navigator.geolocation.getCurrentPosition(position=>{

                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                alert("üì± Shake Detected!\nüì° SOS Sent with Live Location");

                sendSMS(lat, lon);

                L.marker([lat,lon])
                .addTo(map)
                .bindPopup("üì± Shake SOS Location")
                .openPopup();
            });
        }
    }

    lastX=acc.x;
    lastY=acc.y;
    lastZ=acc.z;
});

</script>
</body>
</html>
